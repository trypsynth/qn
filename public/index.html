<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quicknotes</title>
  </head>
  <body>
    <main>
      <textarea id="note" wrap="off"></textarea>
    </main>

    <script type="module">
      import * as Y from "https://cdn.jsdelivr.net/npm/yjs@13.6.13/+esm";

      const noteEl = document.getElementById("note");
      if (!(noteEl instanceof HTMLTextAreaElement)) {
        throw new Error("Textarea not found");
      }
      noteEl.focus();
      const doc = new Y.Doc();
      const ytext = doc.getText("note");
      const wsProtocol = location.protocol === "https:" ? "wss" : "ws";
      const wsUrl = new URL("./ws", location.href);
      wsUrl.protocol = `${wsProtocol}:`;
      const ws = new WebSocket(wsUrl);
      ws.binaryType = "arraybuffer";

      const setStatus = (connected) => {
        noteEl.disabled = !connected;
        document.title = connected ? "Quicknotes" : "Quicknotes (disconnected)";
      };
      setStatus(false);

      ws.addEventListener("open", () => setStatus(true));
      ws.addEventListener("close", () => setStatus(false));
      ws.addEventListener("error", () => setStatus(false));

      ws.addEventListener("message", (event) => {
        const update = new Uint8Array(event.data);
        Y.applyUpdate(doc, update, "remote");
      });

      doc.on("update", (update, origin) => {
        if (origin === "remote") {
          return;
        }
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(update);
        }
      });

      const clampSelection = (value, pos) =>
        Math.max(0, Math.min(value.length, pos));

      ytext.observe(() => {
        const newValue = ytext.toString();
        if (noteEl.value === newValue) {
          return;
        }
        const start = clampSelection(newValue, noteEl.selectionStart);
        const end = clampSelection(newValue, noteEl.selectionEnd);
        noteEl.value = newValue;
        noteEl.setSelectionRange(start, end);
      });

      noteEl.addEventListener("input", () => {
        doc.transact(() => {
          ytext.delete(0, ytext.length);
          ytext.insert(0, noteEl.value);
        }, "local");
      });
    </script>
  </body>
</html>
